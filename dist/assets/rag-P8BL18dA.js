const f="bi_gpt_rag_kb_v1",s="bi_gpt_rag_interactions_v1";function l(){try{const t=localStorage.getItem(f);return t?JSON.parse(t):[]}catch{return[]}}function g(t){try{localStorage.setItem(f,JSON.stringify(t))}catch{}}function i(t){return t.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(Boolean)}function a(t){const o={};for(const r of t)o[r]=(o[r]||0)+1;return o}function m(t,o){let r=0,n=0,c=0;for(const e in t)n+=t[e]*t[e],o[e]&&(r+=t[e]*o[e]);for(const e in o)c+=o[e]*o[e];return n===0||c===0?0:r/(Math.sqrt(n)*Math.sqrt(c))}function p(t){const o=l(),r=new Map(o.map(n=>[n.id,n]));for(const n of t)r.set(n.id,n);g(Array.from(r.values()).slice(-500))}function S(t,o=3){const r=l();if(!t.trim()||r.length===0)return[];const n=a(i(t));return r.map(e=>({id:e.id,score:m(n,a(i(e.text))),text:e.text})).sort((e,u)=>u.score-e.score).slice(0,o).filter(e=>e.score>0).map(e=>e.text)}function _(t){try{const o=Date.now(),r=localStorage.getItem(s),n=r?JSON.parse(r):[];n.push({t:o,u:t.slice(0,2e3)}),localStorage.setItem(s,JSON.stringify(n.slice(-200)))}catch{}}export{_ as recordInteraction,S as retrieveContext,p as upsertDocuments};
